# SPDX-FileCopyrightText: 2025 Weibo, Inc.
#
# SPDX-License-Identifier: Apache-2.0

name: Publish Image

on:
  pull_request:
    types: [closed]
  workflow_dispatch:
    inputs:
      version:
        description: 'Custom version to release (e.g. 1.2.3). If empty, auto-increment from latest git tag'
        type: string
        required: false

env:
  GIT_REF: ${{ github.event_name == 'pull_request' && github.event.pull_request.merge_commit_sha || 'main' }}
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}

concurrency:
  group: publish-image
  cancel-in-progress: false

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: >
      ( github.event_name == 'pull_request' &&
        github.event.pull_request.base.ref == 'main' &&
        github.event.pull_request.merged == true &&
        contains(github.event.pull_request.title, 'Changeset version bump') ) ||
      github.event_name == 'workflow_dispatch'

    outputs:
      new_version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout code (full history for version detection)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Get version from git tags (and bump patch)
        id: get_version
        shell: bash
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail

          # If custom version is provided, use it directly
          if [ -n "${INPUT_VERSION:-}" ]; then
            echo "Using custom version: ${INPUT_VERSION}"
            echo "version=${INPUT_VERSION}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get the latest version tag (format: vX.X.X)
          LATEST_TAG=$(git tag -l 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname | head -1 || true)

          if [ -z "$LATEST_TAG" ]; then
            echo "No existing version tags found, starting from v0.0.1"
            echo "version=0.0.1" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Remove 'v' prefix
          VERSION="${LATEST_TAG#v}"
          echo "Current version: $VERSION (from tag $LATEST_TAG)"

          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          if [ ${#VERSION_PARTS[@]} -ne 3 ]; then
            echo "Error: Invalid version format '$VERSION'. Expected MAJOR.MINOR.PATCH"
            exit 1
          fi

          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          if ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
            echo "Error: PATCH '$PATCH' is not a number"
            exit 1
          fi

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

  build-backend:
    needs: prepare-release
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-backend:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-executor:
    needs: prepare-release
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push executor image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/executor/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-executor:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-executor:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-executor-manager:
    needs: prepare-release
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push executor manager image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/executor_manager/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-executor-manager:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-executor-manager:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-frontend:
    needs: prepare-release
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-web:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-web:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-chat-shell:
    needs: prepare-release
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Checkout code (full history for reproducible builds)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push chat shell image (multi-arch)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/chat_shell/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_PREFIX }}/wegent-chat-shell:${{ needs.prepare-release.outputs.new_version }}
            ${{ env.IMAGE_PREFIX }}/wegent-chat-shell:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release-tag:
    needs:
      - prepare-release
      - build-backend
      - build-chat-shell
      - build-executor
      - build-executor-manager
      - build-frontend
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code (full history + tags)
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GIT_REF }}
          fetch-depth: 0

      - name: Create and push tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare-release.outputs.new_version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch --tags --force

          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "Tag v${VERSION} already exists, skipping tag creation"
          else
            git tag -a "v${VERSION}" -m "Release version ${VERSION}"
            git push origin "v${VERSION}"
            echo "Created and pushed tag v${VERSION}"
          fi

      - name: Generate Release Notes
        id: release-notes
        uses: actions/github-script@v7
        env:
          TAG: v${{ needs.prepare-release.outputs.new_version }}
        with:
          script: |
            const tag = process.env.TAG;
            if (!tag) {
              core.setFailed('TAG env is missing; cannot generate release notes.');
              return;
            }

            try {
              const { data } = await github.rest.repos.generateReleaseNotes({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
              });
              core.setOutput("tag", tag);
              core.setOutput("body", data.body || '');
            } catch (error) {
              core.setFailed(`Failed to generate release notes: ${error.message}`);
            }

      - name: Create GitHub Release
        if: steps.release-notes.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-notes.outputs.tag }}
          name: Release ${{ steps.release-notes.outputs.tag }}
          body: ${{ steps.release-notes.outputs.body }}
          draft: false
          prerelease: false
